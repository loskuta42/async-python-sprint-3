# Проектное задание третьего спринта

Спроектируйте и реализуйте мессенджер для получения и обработки сообщений от клиента.

Кроме основного задания, выберите из списка дополнительные требования.
У каждого требования есть определённая сложность, от которой зависит количество баллов.
Необходимо выбрать такое количество заданий, чтобы общая сумма баллов была больше или равна `4`.
Выбор заданий никак не ограничен: можно выбрать все простые или одно среднее и два простых, или одно продвинутое, или решить все.



## Описание задания

### `Сервер`

Реализовать сервис, который обрабатывает поступающие запросы от клиентов;

Условия и требования:
1. Подключенный клиент добавляется в "общий" чат, где находятся ранее подключенные клиенты;
2. После подключения новому клиенту доступные последние N (по умолчанию 20) сообщений из общего чата;
3. Повторно подключенный клиент имеет возможность просмотреть все ранее непрочитанные сообщения до момента последнего опроса (как из общего чата, так и приватные);
4. По умолчанию сервер стартует на локальном хосте (127.0.0.1) и на 8000 порту (иметь возможность задавать любой);
5. Можно не проектировать БД: информацию хранить в памяти и/или десериализовать/сериализировать в файл (формат на выбор) и восстанавливать при старте сервера;


<details>
<summary> Список возможных методов для взаимодействия (можно изменять) </summary>

1. Подключиться к общему чату
```python
POST /connect
```

2. Получить статус и информацию о чатах
```python
GET /status
```

3. Отправить сообщение в общий чат или определенному пользователю в приватный чат
```python
POST /send
```
</details>


### `Клиент`

Реализовать приложение, который умеет подключаться к серверу и обмениваться сообщениями;

Условия и требования:
1. После подключения клиент может отправлять сообщения в "общий" чат;
2. Возможность отправки сообщения  в приватном чате (1-to-1) любому участнику из общего чата;
3. Разрабатывать UI не надо: можно выводить информацию в консоль или использовать лог-файлы;


### Дополнительные требования (отметить [Х] выбранные пункты):

- [ ] (1 балл) Период жизни доставленных сообщений — 1 час (по умолчанию).
- [X] (1 балл) Клиент может отправлять не более 20 (по умолчанию) сообщений в общий чат в течение определенного периода - 1 час (по умолчанию). В конце каждого периода лимит обнуляется;
- [X] (1 балл) Возможность комментировать сообщения;
- [ ] (2 балла) Возможность создавать сообщения с заранее указанным временем отправки; созданные, но неотправленные сообщения можно отменить;
- [X] (2 балла) Возможность пожаловаться на пользователя. При достижении лимита в 3 предупреждения, пользователь становится "забанен" - невозможность отправки сообщений в течение 4 часов (по умолчанию);
- [ ] (3 балла) Возможность отправлять файлы различного формата (объёмом не более 5Мб, по умолчанию).
- [ ] (3 балла) Пользователь может подключиться с двух и более клиентов одновременно. Состояния должны синхронизироваться между клиентами.
- [ ] (3 балла) Возможность создавать кастомные приватные чаты и приглашать в него других пользователей. Неприглашенный пользователь может "войти" в такой чат только по сгенерированной ссылке и после подтверждения владельцем чата. 
- [X] **(5 баллов) Реализовать кастомную реализацию для взаимодействия по протоколу `http` (можно использовать `asyncio.streams`);


## Требования к решению

1. Описать документацию по разработанному API: вызов по команде/флагу для консольного приложения или эндпойнт для http-сервиса.
2. Используйте концепции ООП.
3. Используйте аннотацию типов.
4. Предусмотрите обработку исключительных ситуаций.
5. Приведите стиль кода в соответствие pep8, flake8, mypy.
6. Логируйте результаты действий. 
7. Покройте написанный код тестами.


## Рекомендации к решению

1. Можно использовать внешние библиотеки, но не фреймворки (описать в **requirements.txt**).

# Документация к разработанному API.

## Сервер

Работает по кастомизированному HTTP протоколу, при работе с разработтаным клиентом поддерживается открытый сокет, до его закрытия стороны клиента. Так же возможно подключение со сторонних клиентов. Все записи хранятся в базе данных. Перед первым зауском необходимо запустить файл models.py, для создание базы данных. Сервер запускается, автоматически при исполнении файла server.py, автоватически запустается на хосте 127.0.0.1 и порте 8000, могут быть изменены.

### Эндпоинты

-  POST /get-token - при первом подключении клиента, отправляет токен клиенту (JSON-формат {"token": "hex(16)"}), при последующих сообщает, что токен уже выдан, при запросе отправляется json тело запроса с указание поля "user_name". При возникновении  ошибок при запросе будет возвращен соответствующий код ошибки, и возвращен ответ с дополнительной информацией.
- GET /status - сообщает под каким именем подключен клиент, а так же информацию о чатах, в формате JSON. Требуется авторизация. При возникновении  ошибок при запросе будет возвращен соответствующий код ошибки, и возвращен ответ с дополнительной информацией. 
- POST /connect - подключение к чату, вернет ответ в формате JSON со списком последних 20 прочитанных сообщений, и списком всех непрочитанных сообщений. Запроса может быть пустым JSON, в таком случае будет получена информация об общем чате, если указать поле "chat_with", указать имя пользователя, будет возвращена информация о приватном чате. При возникновении  ошибок при запросе будет возвращен соответствующий код ошибки, и возвращен ответ с дополнительной информацией.
- POST /send - отправка сообщения в чате (в общий чат в один час допустимо отсылать не более 20 сообщений, при превышении лимита вернется предупреждение, что лимит исчерпан). Необходимо в теле запроса указать поле "message", с указанием в нем текста сообщений. Если необходимо отправить сообщение в приватный чат необходимо, в поле "send_to" указать имя пользователя, для которого предназначено сообщение. При успехе вернется код 201, и сообщение в формате JSON, об успешной отправке. При возникновении  ошибок при запросе будет возвращен соответствующий код ошибки, и возвращен ответ с дополнительной информацией.
- POST /comment - комментировать сообщение. Необходимо указать индентификатор сообщения в поле "message_id" и текст коментария в поле "comment". При успешной отправке коментария вернется код 201, и сообщение в формате JSON, об успешном добавлении коментария. При возникновении  ошибок при запросе будет возвращен соответствующий код ошибки, и возвращен ответ с дополнительной информацией.
- POST /report - возможность пожаловаться на пользователя. Необходимо указать поле "chat_type" с указанием типа чата ("private", "public"), и имени пользователя на которого клиент хочет пожаловаться, при успехе жалобы, будет возвращен код 201, с дополнительной информацией, если пользователь уже забанен будет возвращено информационное сообщение. При возникновении  ошибок при запросе будет возвращен соответствующий код ошибки, и возвращен ответ с дополнительной информацией.

## Клиент

Приложение дял взаимодействия с сервером.

подробно описан в докстрингах в файле client.py

