# API Мессенджер для получения и обработки сообщений от клиентов.

Месседжер работает по кастомизированному HTTP протоколу, при работе с разработанным клиентом поддерживается открытый сокет, до его закрытия со стороны клиента. Так же возможно подключение со сторонних клиентов.

## Стек.
`asyncio`, `sqlite3`, `SQLAlchemy`, `h11`

## Запуск приложения.

1. `Перед первым запуском` необходимо запустить файл [models.py](models.py), для создание базы данных.
2. Сервер запускается, автоматически при исполнении скрипта [server.py](server.py), на хосте `127.0.0.1` и порте `8000` (могут быть изменены).


## Описание приложений

### `Сервер` [server.py](server.py)

Реализован сервис, который обрабатывает поступающие запросы от клиентов;

Функционал:
1. Реализован кастомный `http` протокол [protocol.py](protocol.py).
2. Подключенный клиент добавляется в "общий" чат, где находятся ранее подключенные клиенты;
3. После подключения новому клиенту доступные последние N (по умолчанию 20) сообщений из общего чата;
4. Повторно подключенный клиент имеет возможность просмотреть все ранее непрочитанные сообщения до момента последнего опроса (как из общего чата, так и приватные);
5. По умолчанию сервер стартует на локальном хосте (`127.0.0.1`) и на `8000` порту (иметь возможность задавать любой);
6. Можно не проектировать БД: информацию хранить в памяти и/или десериализовать/сериализировать в файл (формат на выбор) и восстанавливать при старте сервера;
7. Клиент может отправлять не более 20 (по умолчанию) сообщений в общий чат в течение определенного периода - 1 час (по умолчанию). В конце каждого периода лимит обнуляется;
8. Возможность комментировать сообщения;
9. Возможность пожаловаться на пользователя. При достижении лимита в 3 предупреждения, пользователь становится "забанен" - невозможность отправки сообщений в течение 4 часов (по умолчанию);



<details>
<summary> Эндпоинты </summary>

1. При первом подключении клиента, отправляет токен клиенту (`JSON`-формат `{"token": "hex(16)"}`), при последующих сообщает, что токен уже выдан, при запросе отправляется `JSON` тело запроса с указание поля `"user_name"`. При возникновении  ошибок при запросе будет возвращен соответствующий код ошибки, и возвращен ответ с дополнительной информацией.
```python
POST /get-token
```

2. Подключение к чату, вернет ответ в формате `JSON` со списком последних 20 прочитанных сообщений, и списком всех непрочитанных сообщений. Запроса может быть пустым `JSON`, в таком случае будет получена информация об общем чате, если указать поле `"chat_with"`, указать имя пользователя, будет возвращена информация о приватном чате. При возникновении  ошибок при запросе будет возвращен соответствующий код ошибки с дополнительной информацией об ошибке.
```python
POST /connect
```

3. Сообщает под каким именем подключен клиент, а так же информацию о чатах, в формате `JSON`. Требуется авторизация. При возникновении  ошибок при запросе будет возвращен соответствующий код ошибки с дополнительной информацией об ошибке. 
```python
GET /status
```

4. Отправка сообщения в чате (в общий чат в один час допустимо отсылать не более `20` сообщений, при превышении лимита вернется предупреждение, что лимит исчерпан). Необходимо в теле запроса указать поле `"message"`, с указанием в нем текста сообщений. Если необходимо отправить сообщение в приватный чат необходимо, в поле `"send_to"` указать имя пользователя, для которого предназначено сообщение. При успехе вернется код `201`, и сообщение в формате `JSON`, об успешной отправке. При возникновении  ошибок при запросе будет возвращен соответствующий код ошибки с дополнительной информацией об ошибке.
```python
POST /send
```

5. Комментировать сообщение. Необходимо указать идентификатор сообщения в поле `"message_id"` и текст комментария в поле `"comment"`. При успешной отправке комментария вернется код `201`, и сообщение в формате `JSON`, об успешном добавлении комментария. При возникновении  ошибок при запросе будет возвращен соответствующий код ошибки с дополнительной информацией об ошибке.
```python
POST /comment
```

6. Возможность пожаловаться на пользователя. Необходимо указать поле `"chat_type"` с указанием типа чата (`"private"`, `"public"`), и имени пользователя на которого клиент хочет пожаловаться, при успехе жалобы, будет возвращен код `201`, с дополнительной информацией, если пользователь уже забанен будет возвращено информационное сообщение. При возникновении  ошибок при запросе будет возвращен соответствующий код ошибки с дополнительной информацией об ошибке.
```python
POST /report
```
</details>



### `Клиент` [client.py](client.py).

Приложение клиента, который умеет подключаться к серверу и обмениваться сообщениями;

Функционал:
1. После подключения клиент может отправлять сообщения в "общий" чат;
2. Возможность отправки сообщения  в приватном чате (1-to-1) любому участнику из общего чата;
3. Возможность пожаловаться на другого пользователя в общем или приватном чате;
4. Возможность комментировать сообщения.
